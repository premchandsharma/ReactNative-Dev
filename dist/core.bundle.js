"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("react-native"),i=require("react-native-fs"),o=require("react-native-encrypted-storage"),n=require("react-native-device-info"),r=require("react-native-localize"),s=require("@react-native-community/netinfo"),a=require("react-native-view-shot"),l=require("react-native-gesture-handler"),c=require("react-native-video"),d=require("events"),u=require("@react-native-async-storage/async-storage"),h=require("react-native-svg"),p=require("react-native-safe-area-context");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function f(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(i){if("default"!==i){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return e[i]}})}}),t.default=e,Object.freeze(t)}var y,m=g(e),b=g(i),w=g(o),v=g(n),x=f(r),S=g(s),C=g(c),k=g(d),j=g(u),T={exports:{}},I={};var R,O,P={};
/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function _(){return R||(R=1,"production"!==process.env.NODE_ENV&&function(){function e(t){if(null==t)return null;if("function"==typeof t)return t.$$typeof===L?null:t.displayName||t.name||null;if("string"==typeof t)return t;switch(t){case k:return"Fragment";case C:return"Portal";case T:return"Profiler";case j:return"StrictMode";case _:return"Suspense";case z:return"SuspenseList"}if("object"==typeof t)switch("number"==typeof t.tag&&console.error("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),t.$$typeof){case R:return(t.displayName||"Context")+".Provider";case I:return(t._context.displayName||"Context")+".Consumer";case O:var i=t.render;return(t=t.displayName)||(t=""!==(t=i.displayName||i.name||"")?"ForwardRef("+t+")":"ForwardRef"),t;case E:return null!==(i=t.displayName||null)?i:e(t.type)||"Memo";case D:i=t._payload,t=t._init;try{return e(t(i))}catch(e){}}return null}function t(e){return""+e}function i(e){try{t(e);var i=!1}catch(e){i=!0}if(i){var o=(i=console).error,n="function"==typeof Symbol&&Symbol.toStringTag&&e[Symbol.toStringTag]||e.constructor.name||"Object";return o.call(i,"The provided key is an unsupported type %s. This value must be coerced to a string before using it here.",n),t(e)}}function o(){}function n(e){if(void 0===q)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);q=t&&t[1]||"",H=-1<e.stack.indexOf("\n    at")?" (<anonymous>)":-1<e.stack.indexOf("@")?"@unknown:0:0":""}return"\n"+q+e+H}function r(e,t){if(!e||J)return"";var i=G.get(e);if(void 0!==i)return i;J=!0,i=Error.prepareStackTrace,Error.prepareStackTrace=void 0;var r;r=A.H,A.H=null,function(){if(0===N){p=console.log,g=console.info,f=console.warn,y=console.error,b=console.group,w=console.groupCollapsed,v=console.groupEnd;var e={configurable:!0,enumerable:!0,value:o,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}N++}();try{var s={DetermineComponentFrameRoot:function(){try{if(t){var i=function(){throw Error()};if(Object.defineProperty(i.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(i,[])}catch(e){var o=e}Reflect.construct(e,[],i)}else{try{i.call()}catch(e){o=e}e.call(i.prototype)}}else{try{throw Error()}catch(e){o=e}(i=e())&&"function"==typeof i.catch&&i.catch(function(){})}}catch(e){if(e&&o&&"string"==typeof e.stack)return[e.stack,o.stack]}return[null,null]}};s.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var a=Object.getOwnPropertyDescriptor(s.DetermineComponentFrameRoot,"name");a&&a.configurable&&Object.defineProperty(s.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var l=s.DetermineComponentFrameRoot(),c=l[0],d=l[1];if(c&&d){var u=c.split("\n"),h=d.split("\n");for(l=a=0;a<u.length&&!u[a].includes("DetermineComponentFrameRoot");)a++;for(;l<h.length&&!h[l].includes("DetermineComponentFrameRoot");)l++;if(a===u.length||l===h.length)for(a=u.length-1,l=h.length-1;1<=a&&0<=l&&u[a]!==h[l];)l--;for(;1<=a&&0<=l;a--,l--)if(u[a]!==h[l]){if(1!==a||1!==l)do{if(a--,0>--l||u[a]!==h[l]){var m="\n"+u[a].replace(" at new "," at ");return e.displayName&&m.includes("<anonymous>")&&(m=m.replace("<anonymous>",e.displayName)),"function"==typeof e&&G.set(e,m),m}}while(1<=a&&0<=l);break}}}finally{J=!1,A.H=r,function(){if(0===--N){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:$({},e,{value:p}),info:$({},e,{value:g}),warn:$({},e,{value:f}),error:$({},e,{value:y}),group:$({},e,{value:b}),groupCollapsed:$({},e,{value:w}),groupEnd:$({},e,{value:v})})}0>N&&console.error("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}(),Error.prepareStackTrace=i}return u=(u=e?e.displayName||e.name:"")?n(u):"","function"==typeof e&&G.set(e,u),u}function s(e){if(null==e)return"";if("function"==typeof e){var t=e.prototype;return r(e,!(!t||!t.isReactComponent))}if("string"==typeof e)return n(e);switch(e){case _:return n("Suspense");case z:return n("SuspenseList")}if("object"==typeof e)switch(e.$$typeof){case O:return e=r(e.render,!1);case E:return s(e.type);case D:t=e._payload,e=e._init;try{return s(e(t))}catch(e){}}return""}function a(){var e=A.A;return null===e?null:e.getOwner()}function l(){var t=e(this.type);return Y[t]||(Y[t]=!0,console.error("Accessing element.ref was removed in React 19. ref is now a regular prop. It will be removed from the JSX Element type in a future release.")),void 0!==(t=this.props.ref)?t:null}function c(t,o,n,r,s,c){if("string"==typeof t||"function"==typeof t||t===k||t===T||t===j||t===_||t===z||t===V||"object"==typeof t&&null!==t&&(t.$$typeof===D||t.$$typeof===E||t.$$typeof===R||t.$$typeof===I||t.$$typeof===O||t.$$typeof===W||void 0!==t.getModuleId)){var u=o.children;if(void 0!==u)if(r)if(M(u)){for(r=0;r<u.length;r++)d(u[r],t);Object.freeze&&Object.freeze(u)}else console.error("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else d(u,t)}else u="",(void 0===t||"object"==typeof t&&null!==t&&0===Object.keys(t).length)&&(u+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports."),null===t?r="null":M(t)?r="array":void 0!==t&&t.$$typeof===S?(r="<"+(e(t.type)||"Unknown")+" />",u=" Did you accidentally export a JSX literal instead of a component?"):r=typeof t,console.error("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",r,u);if(B.call(o,"key")){u=e(t);var h=Object.keys(o).filter(function(e){return"key"!==e});r=0<h.length?"{key: someKey, "+h.join(": ..., ")+": ...}":"{key: someKey}",K[u+r]||(h=0<h.length?"{"+h.join(": ..., ")+": ...}":"{}",console.error('A props object containing a "key" prop is being spread into JSX:\n  let props = %s;\n  <%s {...props} />\nReact keys must be passed directly to JSX without using spread:\n  let props = %s;\n  <%s key={someKey} {...props} />',r,u,h,u),K[u+r]=!0)}if(u=null,void 0!==n&&(i(n),u=""+n),function(e){if(B.call(e,"key")){var t=Object.getOwnPropertyDescriptor(e,"key").get;if(t&&t.isReactWarning)return!1}return void 0!==e.key}(o)&&(i(o.key),u=""+o.key),"key"in o)for(var p in n={},o)"key"!==p&&(n[p]=o[p]);else n=o;return u&&function(e,t){function i(){U||(U=!0,console.error("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://react.dev/link/special-props)",t))}i.isReactWarning=!0,Object.defineProperty(e,"key",{get:i,configurable:!0})}(n,"function"==typeof t?t.displayName||t.name||"Unknown":t),function(e,t,i,o,n,r){return i=r.ref,e={$$typeof:S,type:e,key:t,props:r,_owner:n},null!==(void 0!==i?i:null)?Object.defineProperty(e,"ref",{enumerable:!1,get:l}):Object.defineProperty(e,"ref",{enumerable:!1,value:null}),e._store={},Object.defineProperty(e._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:0}),Object.defineProperty(e,"_debugInfo",{configurable:!1,enumerable:!1,writable:!0,value:null}),Object.freeze&&(Object.freeze(e.props),Object.freeze(e)),e}(t,u,c,0,a(),n)}function d(e,t){if("object"==typeof e&&e&&e.$$typeof!==X)if(M(e))for(var i=0;i<e.length;i++){var o=e[i];u(o)&&h(o,t)}else if(u(e))e._store&&(e._store.validated=1);else if(null===e||"object"!=typeof e?i=null:i="function"==typeof(i=F&&e[F]||e["@@iterator"])?i:null,"function"==typeof i&&i!==e.entries&&(i=i.call(e))!==e)for(;!(e=i.next()).done;)u(e.value)&&h(e.value,t)}function u(e){return"object"==typeof e&&null!==e&&e.$$typeof===S}function h(t,i){if(t._store&&!t._store.validated&&null==t.key&&(t._store.validated=1,i=function(t){var i="",o=a();return o&&(o=e(o.type))&&(i="\n\nCheck the render method of `"+o+"`."),i||(t=e(t))&&(i="\n\nCheck the top-level render call using <"+t+">."),i}(i),!Q[i])){Q[i]=!0;var o="";t&&null!=t._owner&&t._owner!==a()&&(o=null,"number"==typeof t._owner.tag?o=e(t._owner.type):"string"==typeof t._owner.name&&(o=t._owner.name),o=" It was passed a child from "+o+".");var n=A.getCurrentStack;A.getCurrentStack=function(){var e=s(t.type);return n&&(e+=n()||""),e},console.error('Each child in a list should have a unique "key" prop.%s%s See https://react.dev/link/warning-keys for more information.',i,o),A.getCurrentStack=n}}var p,g,f,y,b,w,v,x=m.default,S=Symbol.for("react.transitional.element"),C=Symbol.for("react.portal"),k=Symbol.for("react.fragment"),j=Symbol.for("react.strict_mode"),T=Symbol.for("react.profiler"),I=Symbol.for("react.consumer"),R=Symbol.for("react.context"),O=Symbol.for("react.forward_ref"),_=Symbol.for("react.suspense"),z=Symbol.for("react.suspense_list"),E=Symbol.for("react.memo"),D=Symbol.for("react.lazy"),V=Symbol.for("react.offscreen"),F=Symbol.iterator,L=Symbol.for("react.client.reference"),A=x.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,B=Object.prototype.hasOwnProperty,$=Object.assign,W=Symbol.for("react.client.reference"),M=Array.isArray,N=0;o.__reactDisabledLog=!0;var q,H,U,J=!1,G=new("function"==typeof WeakMap?WeakMap:Map),X=Symbol.for("react.client.reference"),Y={},K={},Q={};P.Fragment=k,P.jsx=function(e,t,i,o,n){return c(e,t,i,!1,0,n)},P.jsxs=function(e,t,i,o,n){return c(e,t,i,!0,0,n)}}()),P}var z=(O||(O=1,"production"===process.env.NODE_ENV?T.exports=function(){if(y)return I;y=1;var e=Symbol.for("react.transitional.element"),t=Symbol.for("react.fragment");function i(t,i,o){var n=null;if(void 0!==o&&(n=""+o),void 0!==i.key&&(n=""+i.key),"key"in i)for(var r in o={},i)"key"!==r&&(o[r]=i[r]);else o=i;return i=o.ref,{$$typeof:e,type:t,key:n,ref:void 0!==i?i:null,props:o}}return I.Fragment=t,I.jsx=i,I.jsxs=i,I}():T.exports=_()),T.exports);async function E(e,t){var i;const o=null===(i=e.split("/").pop())||void 0===i?void 0:i.split("?")[0],n=`${b.default.DocumentDirectoryPath}/${o}`;try{if(await b.default.exists(n))return t(n);const i=await b.default.downloadFile({fromUrl:e,toFile:n}).promise;200===i.statusCode?(console.log("Image downloaded!"),t(n)):console.error("Failed to download image:",i)}catch(e){console.error("Error checking cache for image:",e)}}const D=e=>{let t;const i=new Set,o=(e,o)=>{const n="function"==typeof e?e(t):e;if(!Object.is(n,t)){const e=t;t=(null!=o?o:"object"!=typeof n||null===n)?n:Object.assign({},t,n),i.forEach(i=>i(t,e))}},n=()=>t,r={setState:o,getState:n,getInitialState:()=>s,subscribe:e=>(i.add(e),()=>i.delete(e))},s=t=e(o,n,r);return r},V=e=>e;const F=e=>{const t=(e=>e?D(e):D)(e),i=e=>function(e,t=V){const i=m.default.useSyncExternalStore(e.subscribe,m.default.useCallback(()=>t(e.getState()),[e,t]),m.default.useCallback(()=>t(e.getInitialState()),[e,t]));return m.default.useDebugValue(i),i}(t,e);return Object.assign(i,t),i},L=e=>e?F(e):F,A=L(e=>({campaigns:[],userId:"",appId:"",accountId:"",attributes:void 0,screenOptions:void 0,setCampaigns:t=>e({campaigns:t}),setUserId:t=>e({userId:t}),setAppId:t=>e({appId:t}),setAccountId:t=>e({accountId:t}),setAttributes:t=>e({attributes:t}),setScreenOptions:t=>e({screenOptions:t})}));function B(){return A.getState().appId}function $(){return A.getState().userId}async function W(){return w.default.getItem("access_token")}function M(t){const i=A(e=>e.campaigns);return e.useMemo(()=>i.find(e=>e.campaign_type===t),[i,t])}async function N(){try{const{width:e,height:i}=t.Dimensions.get("window"),o=x.getLocales()[0];return{manufacturer:await v.default.getManufacturer(),model:v.default.getModel(),os_version:v.default.getSystemVersion(),api_level:await v.default.getApiLevel(),language:null==o?void 0:o.languageCode,locale:null==o?void 0:o.languageTag,timezone:x.getTimeZone(),screen_width_px:e,screen_height_px:i,screen_density:t.Dimensions.get("screen").scale,orientation:e<i?"portrait":"landscape",app_version:v.default.getVersion(),package_name:v.default.getBundleId(),device_type:v.default.isTablet()?"tablet":"mobile",platform:v.default.getSystemName().toLowerCase()}}catch(e){return console.error("Error fetching device info:",e),{}}}const q="offline_queue";async function H(){const e=await w.default.getItem(q);return e?JSON.parse(e):[]}async function U(e){await w.default.setItem(q,JSON.stringify(e))}async function J(e){const t=await H();t.push(e),await U(t),console.log("ðŸ“¦ Request saved offline:",e.url)}async function G(e){if((await S.default.fetch()).isConnected){await async function(){const e=await H();if(0===e.length)return;console.log(`ðŸš€ Flushing ${e.length} queued requests...`);const t=[];for(const i of e)try{(await fetch(i.url,{method:i.method,headers:i.headers,body:JSON.stringify(i.body)})).ok?console.log("âœ… Successfully resent:",i.url):(console.warn("âŒ Failed to resend, keeping in queue:",i.url),t.push(i))}catch(e){console.error("âš ï¸ Network error, keeping in queue:",i.url,e),t.push(i)}await U(t)}();try{const t=await fetch(e.url,{method:e.method,headers:e.headers,body:JSON.stringify(e.body)});return t.ok?(console.log("âœ… Request sent successfully:",e.url),t):(console.warn("âŒ Request failed, saving offline:",e.url,e.body,t.status),void await J(e))}catch(t){return void await J(e)}}else await J(e)}async function X(e,t,i){try{const o=await W();if(!o)return void console.error("Error in trackEvent. Access token not found");const n=await N(),r={...i||{},...n},s={user_id:$(),event:e,metadata:r};t&&(s.campaign_id=t);const a=G({url:"https://tracking.appstorys.com/capture-event",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:s});a instanceof Response&&!a.ok&&console.error("Something went wrong in trackEvent:",a.status,a.statusText)}catch(e){console.error("Error in trackEvent",e)}}function Y(t){const i=A(e=>{var t;return null===(t=e.screenOptions)||void 0===t?void 0:t.overlayPadding});return e.useMemo(()=>{if("number"==typeof i)return{top:i,bottom:i};if("object"==typeof i){if("top"in i||"bottom"in i)return i;if("PIP"===t&&"pip"in i)return"number"==typeof i.pip?{top:i.pip,bottom:i.pip}:i.pip||null;if("FLT"===t&&"floater"in i)return{top:i.floater,bottom:i.floater};if("BAN"===t&&"banner"in i)return{top:i.banner,bottom:i.banner};if("CSAT"===t&&"csat"in i)return{top:i.csat,bottom:i.csat}}return null},[i,t])}function K(){var i;const{width:o}=t.Dimensions.get("window"),[n,r]=e.useState(!0),[s,a]=e.useState(null),[l,c]=e.useState(100),[d,u]=e.useState(parseInt("0")),[h,p]=e.useState(parseInt("0")),[g,f]=e.useState(parseInt("0")),[y,m]=e.useState(parseInt("0")),[b,w]=e.useState(parseInt("0")),[v,x]=e.useState(parseInt("0")),[S,C]=e.useState(parseInt("0")),[k,j]=e.useState(!1),T=M("BAN"),I=(null===(i=Y("BAN"))||void 0===i?void 0:i.bottom)||0,R=e.useCallback(()=>{r(!1)},[]);e.useEffect(()=>{T&&T.id&&(X("viewed",T.id),E(T.details.image,e=>{a(e),T.details.styling&&(u(parseInt(T.details.styling.bottomLeftRadius||"0")),p(parseInt(T.details.styling.bottomRightRadius||"0")),f(parseInt(T.details.styling.topLeftRadius||"0")),m(parseInt(T.details.styling.topRightRadius||"0")),w(parseInt(T.details.styling.marginBottom||"0")),x(parseInt(T.details.styling.marginLeft||"0")),C(parseInt(T.details.styling.marginRight||"0")),j(Boolean(T.details.styling.enableCloseButton)));const i=o-(v+S);t.Image.getSize(`file://${e}`,(e,t)=>{c(i*(t/e))},e=>{console.error("Failed to get image size:",e)})}))},[T,o]);const O=o-v-S;return z.jsx(z.Fragment,{children:T&&T.details&&""!==T.details.image&&n&&z.jsx(t.View,{style:{position:"absolute",left:v,right:S,bottom:b+I,alignItems:"center",justifyContent:"flex-end"},children:z.jsxs(t.TouchableOpacity,{activeOpacity:1,onPress:()=>{T.details.link&&(X("clicked",T.id),t.Linking.openURL(T.details.link))},style:[Q.banner,{width:O,height:l,borderTopRightRadius:y,borderTopLeftRadius:g,borderBottomRightRadius:h,borderBottomLeftRadius:d,backgroundColor:"transparent",overflow:"hidden"}],children:[z.jsx(t.Image,{source:{uri:`file://${s}`},style:{width:O,height:l,resizeMode:"cover",borderTopRightRadius:y,borderTopLeftRadius:g,borderBottomRightRadius:h,borderBottomLeftRadius:d}}),k&&z.jsx(t.TouchableOpacity,{onPress:R,style:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0, 0, 0, 1)",borderRadius:15,padding:6,justifyContent:"center",alignItems:"center"},activeOpacity:1,children:z.jsx(t.Image,{source:require("../assets/images/close.png"),style:Q.closeIcon})})]})})})}const Q=t.StyleSheet.create({banner:{alignItems:"center",justifyContent:"center",position:"relative"},closeIcon:{height:8,width:8,tintColor:"white"}});async function Z(e,t,i){try{const o=await W();if(!o)return void console.log("Error in captureSurveyResponse. Access token not found");const n={user_id:$(),survey:e,responseOptions:t,...i&&{comment:i}},r=await fetch("https://backend.appstorys.com/api/v1/campaigns/capture-survey-response/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(n)});if(200!==r.status&&201!==r.status)return void console.log(`Error in captureSurveyResponse. Something went wrong ${await r.text()}`)}catch(e){console.log("Error in captureSurveyResponse:",e)}}function ee(){const{height:i,width:o}=t.Dimensions.get("window"),[n,r]=e.useState(!0),[s,a]=e.useState([]),[l,c]=e.useState(""),d=M("SUR");e.useEffect(()=>{d&&d.id&&X("viewed",d.id)},[d]);const u=()=>{r(!1)};if(!n||!d||!d.details)return null;const h=Object.entries(d.details.surveyOptions).map(([e,t])=>({id:e,name:t}));if(d.details.hasOthers){const e=String.fromCharCode(65+h.length);h.push({id:e,name:"Others"})}return z.jsx(t.View,{style:{position:"absolute",height:i,width:o,backgroundColor:"rgba(0, 0, 0, 0.4)"},children:z.jsx(t.ScrollView,{contentContainerStyle:{flexGrow:1,justifyContent:"center",padding:20},children:z.jsxs(t.View,{style:{width:.9*o,backgroundColor:d.details.styling.backgroundColor,borderRadius:18,paddingHorizontal:20,paddingTop:12,paddingBottom:20,alignSelf:"center"},children:[z.jsxs(t.View,{style:{height:.05*i,justifyContent:"center",marginBottom:12},children:[z.jsx(t.Text,{style:{color:d.details.styling.surveyQuestionColor,fontSize:20,fontWeight:"500",textAlign:"center"},children:d.details.name}),z.jsx(t.TouchableOpacity,{activeOpacity:.7,style:{position:"absolute",right:0,top:10,backgroundColor:d.details.styling.ctaBackgroundColor,padding:10,borderRadius:25},onPress:u,children:z.jsx(t.Image,{source:require("../assets/images/close.png"),style:{tintColor:d.details.styling.ctaTextIconColor,width:12,height:12}})})]}),z.jsx(t.Text,{style:{color:d.details.styling.surveyQuestionColor,fontSize:18,fontWeight:"700",marginBottom:20},children:d.details.surveyQuestion}),h.map(e=>z.jsxs(t.TouchableOpacity,{activeOpacity:.7,onPress:()=>{return t=e.name,void a(e=>e.includes(t)?e.filter(e=>e!==t):[...e,t]);var t},style:{marginBottom:12,padding:16,flexDirection:"row",alignItems:"center",backgroundColor:s.includes(e.name)?d.details.styling.selectedOptionColor:d.details.styling.optionColor,borderRadius:12},children:[z.jsx(t.View,{style:{backgroundColor:"white",borderRadius:18,borderWidth:.8,borderColor:"black",paddingVertical:4,paddingHorizontal:8},children:z.jsx(t.Text,{style:{color:"black",fontSize:12,fontWeight:"600"},children:e.id})}),z.jsx(t.Text,{style:{marginLeft:12,color:s.includes(e.name)?d.details.styling.selectedOptionTextColor:d.details.styling.optionTextColor,fontSize:14,fontWeight:"400"},children:e.name})]},e.id)),s.includes("Others")&&z.jsx(t.TextInput,{style:{height:.057*i,marginBottom:.04*o,backgroundColor:"white",borderRadius:8,borderWidth:2.5,borderColor:d.details.styling.othersBackgroundColor,paddingHorizontal:.015*i,color:"black"},placeholder:"Please enter Others textâ€¦..upto 200 chars",placeholderTextColor:"black",value:l,onChangeText:c,maxLength:200}),z.jsx(t.TouchableOpacity,{activeOpacity:.7,onPress:()=>{d&&s.length>0&&(Z(d.details.id,s,l||void 0),u())},style:{backgroundColor:d.details.styling.ctaBackgroundColor,borderRadius:12,padding:14},children:z.jsx(t.Text,{style:{color:d.details.styling.ctaTextIconColor,fontSize:18,fontWeight:"500",textAlign:"center"},children:"SUBMIT"})})]})})})}async function te(e,t,i,o){try{const n=await W();if(!n)return void console.log("Error in captureCsatResponse. Access token not found");const r={csat:e,user_id:$(),rating:t,...i&&{feedback_option:i},...o&&{additional_comments:o}},s=await fetch("https://backend.appstorys.com/api/v1/campaigns/capture-csat-response/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(r)});if(200!==s.status&&201!==s.status)return void console.log(`Error in captureCsatResponse. Something went wrong ${await s.text()}`)}catch(e){console.log("Error in captureCsatResponse:",e)}}function ie(){var i;const[o,n]=e.useState(!1),[r,s]=e.useState(0),[a,l]=e.useState(!1),[c,d]=e.useState(!1),[u,h]=e.useState(null),[p,g]=e.useState(""),f=M("CSAT"),y=(null===(i=Y("CSAT"))||void 0===i?void 0:i.bottom)||0;e.useEffect(()=>{var e,t;if(f&&f.id&&!ne.has(f.id))try{const i=null===(t=null===(e=f.details)||void 0===e?void 0:e.styling)||void 0===t?void 0:t.displayDelay,o="string"==typeof i?parseInt(i):i||0;setTimeout(async()=>{X("viewed",f.id),n(!0),ne.add(f.id)},1e3*o)}catch(e){console.error("Error checking CSAT status:",e)}},[f]);if(!o||!f||!f.details)return null;const m=Object.entries(f.details.feedback_option||{}).map(([e,t])=>({id:e,name:t}));return z.jsx(t.View,{style:[oe.container,{bottom:y+10}],children:z.jsxs(t.View,{style:[oe.card,{backgroundColor:f.details.styling.csatBackgroundColor}],children:[z.jsx(t.TouchableOpacity,{style:{position:"absolute",top:16,right:16,backgroundColor:f.details.styling.csatCtaBackgroundColor,borderRadius:16,padding:8,zIndex:1},onPress:()=>n(!1),children:z.jsx(t.Image,{source:require("../assets/images/close.png"),style:{tintColor:f.details.styling.csatCtaTextColor,width:13,height:13}})}),z.jsx(t.ScrollView,{children:a?z.jsxs(t.View,{style:oe.thanksContainer,children:[f.details.thankyouImage&&z.jsx(t.Image,{source:{uri:f.details.thankyouImage},style:oe.thanksImage}),z.jsx(t.Text,{style:[oe.thanksTitle,{color:f.details.styling.csatTitleColor}],children:f.details.thankyouText}),z.jsx(t.Text,{style:[oe.thanksDescription,{color:f.details.styling.csatDescriptionTextColor}],children:f.details.thankyouDescription}),z.jsx(t.TouchableOpacity,{style:[oe.button,{backgroundColor:f.details.styling.csatCtaBackgroundColor}],onPress:()=>{n(!1),r>3&&t.Linking.openURL(f.details.link)},children:z.jsx(t.Text,{style:[oe.buttonText,{color:f.details.styling.csatCtaTextColor}],children:r>3?f.details.highStarText||"Done":f.details.lowStarText||"Done"})})]}):z.jsxs(t.View,{children:[z.jsx(t.Text,{style:[oe.title,{color:f.details.styling.csatTitleColor}],children:f.details.title}),z.jsx(t.Text,{style:[oe.description,{color:f.details.styling.csatDescriptionTextColor}],children:f.details.description_text}),z.jsx(t.View,{style:oe.starsContainer,children:Array.from({length:5}).map((e,i)=>z.jsx(t.TouchableOpacity,{onPress:()=>(e=>{const t=e+1;s(t),t>=4?setTimeout(()=>{l(!0),f&&te(f.details.id,t,u||void 0,p||void 0)},1e3):d(!0)})(i),activeOpacity:1,children:z.jsx(t.Image,{source:require("../assets/images/star.png"),style:{tintColor:i<r?r>3?f.details.styling.csatHighStarColor:f.details.styling.csatLowStarColor:f.details.styling.csatUnselectedStarColor,width:32,height:32,marginEnd:6}})},i))}),c&&z.jsxs(t.View,{style:oe.feedbackContainer,children:[m.map(e=>z.jsx(t.TouchableOpacity,{activeOpacity:1,style:[oe.optionButton,{backgroundColor:u===e.name?f.details.styling.csatSelectedOptionBackgroundColor:f.details.styling.csatOptionBoxColour,borderColor:u===e.name?f.details.styling.csatSelectedOptionStrokeColor:f.details.styling.csatOptionStrokeColor}],onPress:()=>h(e.name),children:z.jsx(t.Text,{style:[oe.optionText,{color:u===e.name?f.details.styling.csatSelectedOptionTextColor:f.details.styling.csatOptionTextColour}],children:e.name})},e.id)),z.jsx(t.TextInput,{style:[oe.input,{color:f.details.styling.csatAdditionalTextColor}],value:p,onChangeText:g,placeholder:"Your feedback",placeholderTextColor:f.details.styling.csatDescriptionTextColor}),z.jsx(t.TouchableOpacity,{style:[oe.submitButton,{backgroundColor:f.details.styling.csatCtaBackgroundColor}],onPress:()=>{f&&te(f.details.id,r,u||void 0,p||void 0),l(!0)},children:z.jsx(t.Text,{style:[oe.submitText,{color:f.details.styling.csatCtaTextColor}],children:"Submit"})})]})]})})]})})}const oe=t.StyleSheet.create({container:{position:"absolute",left:10,right:10},card:{borderRadius:24,paddingTop:24,paddingBottom:24,paddingLeft:40,paddingRight:40},thanksContainer:{alignItems:"center"},thanksImage:{width:66,height:66},thanksTitle:{fontSize:20,fontWeight:"bold",marginTop:8},thanksDescription:{fontSize:14,marginTop:4},title:{fontSize:22,fontWeight:"bold"},description:{fontSize:14,marginTop:4},starsContainer:{flexDirection:"row",marginTop:16,marginBottom:12},rateText:{fontSize:16,marginTop:8,marginLeft:8},feedbackContainer:{marginTop:8},feedbackPrompt:{fontSize:14,marginBottom:12},optionButton:{borderWidth:1,borderRadius:24,padding:6,paddingHorizontal:12,marginVertical:4,alignSelf:"flex-start"},optionText:{fontSize:14},input:{borderWidth:1,borderColor:"#000",borderRadius:8,padding:8,marginTop:8},button:{borderRadius:20,paddingHorizontal:32,paddingVertical:6,marginTop:16},buttonText:{fontWeight:"600",fontSize:16},submitButton:{borderRadius:20,paddingHorizontal:32,paddingVertical:6,marginTop:18,alignSelf:"flex-start"},submitText:{fontWeight:"600",fontSize:16}}),ne=new Set;function re({leftPadding:i=0,rightPadding:o=0}){const n=e.useRef(null),r=t.Dimensions.get("window").width,[s,a]=e.useState(0),l=e.useRef(null),[c,d]=e.useState(100),[u,h]=e.useState(parseInt("0")),[p,g]=e.useState(parseInt("0")),[f,y]=e.useState(parseInt("0")),[m,b]=e.useState(parseInt("0")),[w,v]=e.useState(parseInt("0")),[x,S]=e.useState(parseInt("0")),[C,k]=e.useState(parseInt("0")),[j,T]=e.useState(parseInt("0")),[I,R]=e.useState([]),[O,P]=e.useState(!1),_=M("WID"),D=r-C-j-i-o;e.useEffect(()=>{var e;if(!(null===(e=null==_?void 0:_.details)||void 0===e?void 0:e.widget_images))return;(async()=>{var e;const i=_.details.widget_images.map(e=>new Promise(t=>{E(e.image,i=>{t({...e,cachedImagePath:i})})}));try{const o=await Promise.all(i);R(o),(null===(e=o[0])||void 0===e?void 0:e.cachedImagePath)?t.Image.getSize(`file://${o[0].cachedImagePath}`,(e,t)=>{d(D*(t/e)),P(!0)},e=>{console.error("Failed to get image size:",e),P(!0)}):P(!0),_.details.styling&&(h(parseInt(_.details.styling.bottomLeftRadius||"0")),g(parseInt(_.details.styling.bottomRightRadius||"0")),y(parseInt(_.details.styling.topLeftRadius||"0")),b(parseInt(_.details.styling.topRightRadius||"0")),v(parseInt(_.details.styling.bottomMargin||"0")),S(parseInt(_.details.styling.topMargin||"0")),k(parseInt(_.details.styling.leftMargin||"0")),T(parseInt(_.details.styling.rightMargin||"0")))}catch(e){console.error("Error caching images:",e),P(!0)}})()},[_,D]);const V=e.useMemo(()=>O&&I.length?I.filter(e=>void 0!==e):[],[I,O]),F=()=>{_&&n.current&&V.length&&"full"===_.details.type&&(s!==_.details.widget_images.length-1?n.current.scrollToOffset({offset:D*(s+1),animated:!0}):l.current&&(clearInterval(l.current),l.current=null))};e.useEffect(()=>("full"===(null==_?void 0:_.details.type)&&s<_.details.widget_images.length-1&&(l.current&&clearInterval(l.current),l.current=setInterval(F,5e3)),()=>{l.current&&clearInterval(l.current)}),[s,_,V.length]);const L=e.useRef([]);return _&&_.details.widget_images&&O?z.jsxs(t.View,{style:{width:"100%",backgroundColor:"transparent",marginTop:x,marginBottom:w,paddingLeft:C,paddingRight:j},children:[z.jsx(t.FlatList,{data:V,ref:n,getItemLayout:"full"===_.details.type?(e,t)=>({data:e,length:D,offset:D*t,index:t}):void 0,renderItem:"full"===_.details.type?({item:e,index:i})=>{const o=e.cachedImagePath?{uri:`file://${e.cachedImagePath}`}:{uri:e.image};return z.jsx(t.View,{style:{width:D,marginHorizontal:0},children:z.jsx(t.TouchableOpacity,{activeOpacity:1,onPress:()=>{_&&e.link&&(X("clicked",_.id,{widget_image:e.id}),t.Linking.openURL(e.link))},children:z.jsx(t.Image,{source:o,style:{borderTopRightRadius:m,borderTopLeftRadius:f,borderBottomRightRadius:p,borderBottomLeftRadius:u,height:c,width:D,resizeMode:"cover"}})})},`${e.order}-${i}`)}:({item:e,index:i})=>{const o=.455*D,n=.03*D,r=e.cachedImagePath?{uri:`file://${e.cachedImagePath}`}:{uri:e.image};return z.jsx(t.View,{style:{width:o,marginLeft:n},children:z.jsx(t.TouchableOpacity,{activeOpacity:1,onPress:()=>{_&&e.link&&(X("clicked",_.id,{widget_image:e.id}),t.Linking.openURL(e.link))},children:z.jsx(t.Image,{source:r,style:{borderTopRightRadius:m,borderTopLeftRadius:f,borderBottomRightRadius:p,borderBottomLeftRadius:u,height:c/2-.045*D,width:o,resizeMode:"cover"}})})},`${e.order}-${i}`)},keyExtractor:(e,t)=>`${e.image}-${t}`,horizontal:!0,pagingEnabled:"full"===_.details.type,onViewableItemsChanged:({viewableItems:e})=>{e.forEach(({item:e})=>{var t;t=e.id,_&&!L.current.includes(t)?(console.log(`Tracking impression for: ${t}`),L.current.push(t),X("viewed",_.id,{widget_image:t})):console.log(`Impression already tracked for: ${t}`)})},viewabilityConfig:{viewAreaCoveragePercentThreshold:50},onScroll:"full"===_.details.type?e=>{if(_&&"full"!==_.details.type)return;const t=e.nativeEvent.contentOffset.x,i=Math.round(t/D);a(i),i<_.details.widget_images.length-1?l.current&&(clearInterval(l.current),l.current=setInterval(F,5e3)):l.current&&(clearInterval(l.current),l.current=null)}:void 0,showsHorizontalScrollIndicator:!1,initialScrollIndex:"full"===_.details.type?0:void 0,onLayout:()=>{var e;"full"===_.details.type&&(null===(e=n.current)||void 0===e||e.scrollToOffset({offset:0,animated:!1}))},scrollEnabled:"full"===_.details.type,contentContainerStyle:{paddingRight:"half"===_.details.type?.03*D:0}}),"full"===_.details.type&&z.jsx(t.View,{style:{bottom:0,left:0,right:0,flexDirection:"row",justifyContent:"center"},children:null==_?void 0:_.details.widget_images.map((e,i)=>z.jsx(t.View,{style:{backgroundColor:s===i?"black":"grey",height:6,width:s===i?12:6,borderRadius:5,marginHorizontal:3,marginVertical:6}},i))})]}):null}const{height:se}=t.Dimensions.get("window");function ae(){var i;const[o,n]=e.useState(!1),[r,s]=e.useState({}),a=e.useRef(new t.Animated.Value(se)).current,l=e.useRef(new t.Animated.Value(0)).current,[c,d]=e.useState(!1),u=M("BTS"),h=(null==u?void 0:u.details)||null,p=(null===(i=null==h?void 0:h.elements)||void 0===i?void 0:i.sort((e,t)=>(e.order||0)-(t.order||0)))||[],g=p.find(e=>"image"===e.type),f=p.filter(e=>"body"===e.type),y=p.filter(e=>"cta"===e.type),m=e.useRef(t.PanResponder.create({onStartShouldSetPanResponder:()=>!0,onMoveShouldSetPanResponder:(e,t)=>Math.abs(t.dy)>10,onPanResponderMove:(e,t)=>{t.dy>0&&a.setValue(Math.max(0,t.dy))},onPanResponderRelease:(e,i)=>{i.dy>50||i.vy>.5?w():t.Animated.spring(a,{toValue:0,useNativeDriver:!0,tension:100,friction:8}).start()}})).current,b=()=>{n(!0),a.setValue(se),l.setValue(0),t.Animated.parallel([t.Animated.timing(l,{toValue:1,duration:300,useNativeDriver:!0,easing:t.Easing.out(t.Easing.quad)}),t.Animated.spring(a,{toValue:0,useNativeDriver:!0,tension:100,friction:8})]).start()};e.useEffect(()=>{(null==u?void 0:u.id)&&h&&(X("viewed",u.id),(null==g?void 0:g.url)&&E(g.url,e=>{s(t=>({...t,[g.url]:e}))}),setTimeout(b,100))},[null==u?void 0:u.id,h,null==g?void 0:g.url]);const w=()=>{t.Animated.parallel([t.Animated.timing(l,{toValue:0,duration:200,useNativeDriver:!0,easing:t.Easing.in(t.Easing.quad)}),t.Animated.timing(a,{toValue:se,duration:250,useNativeDriver:!0,easing:t.Easing.in(t.Easing.quad)})]).start(()=>{n(!1),d(!1)})},v=e=>{e&&(null==u?void 0:u.id)&&(X("clicked",u.id),(e=>{if(!e)return!1;try{return e.startsWith("http://")||e.startsWith("https://")}catch{return!1}})(e)&&t.Linking.openURL(e).catch(e=>console.error("Failed to open URL:",e)))},x=(e,t="#000000")=>{if(!e)return t;try{return e.startsWith("#")||e.startsWith("#")?e:`#${e}`}catch{return t}},S=e=>{switch(e){case"left":return"left";case"right":return"right";default:return"center"}},C=e=>{switch(e){case"left":return"flex-start";case"right":return"flex-end";default:return"center"}},k=e=>{const i=r[e.url];if(!i)return null;const o=i.startsWith("file://")||i.startsWith("http")?{uri:i}:{uri:`file://${i}`};return z.jsx(t.TouchableOpacity,{onPress:()=>v(e.imageLink),activeOpacity:1,style:[le.imageContainer,{paddingLeft:parseFloat(e.paddingLeft||"0"),paddingRight:parseFloat(e.paddingRight||"0"),paddingTop:parseFloat(e.paddingTop||"0"),paddingBottom:parseFloat(e.paddingBottom||"0"),justifyContent:C(e.alignment)}],children:z.jsx(t.Image,{source:o,style:le.image,resizeMode:"cover"})},`image-${e.order}`)},j=e=>{var i,o,n,r;const s=parseFloat(e.titleFontSize||"16"),a=parseFloat(e.descriptionFontSize||"14"),l=parseFloat(e.spacingBetweenTitleDesc||"8"),c=x(null===(i=e.titleFontStyle)||void 0===i?void 0:i.colour,"#000000"),d=x(null===(o=e.descriptionFontStyle)||void 0===o?void 0:o.colour,"#000000"),u=x(e.bodyBackgroundColor,"#FFFFFF"),h=(null===(n=e.titleFontStyle)||void 0===n?void 0:n.decoration)||"",p=(null===(r=e.descriptionFontStyle)||void 0===r?void 0:r.decoration)||"";return z.jsxs(t.View,{style:[le.bodyContainer,{backgroundColor:u,paddingLeft:parseFloat(e.paddingLeft||"0"),paddingRight:parseFloat(e.paddingRight||"0"),paddingTop:parseFloat(e.paddingTop||"0"),paddingBottom:parseFloat(e.paddingBottom||"0"),alignItems:"left"===e.alignment?"flex-start":"right"===e.alignment?"flex-end":"center"}],children:[e.titleText&&z.jsx(t.Text,{style:[le.titleText,{color:c,fontSize:s,textAlign:S(e.alignment),fontWeight:h.includes("bold")?"bold":"normal",fontStyle:h.includes("italic")?"italic":"normal",textDecorationLine:h.includes("underline")?"underline":"none",lineHeight:parseFloat(e.titleLineHeight||"1")*s}],children:e.titleText}),e.titleText&&e.descriptionText&&z.jsx(t.View,{style:{height:l}}),e.descriptionText&&z.jsx(t.Text,{style:[le.descriptionText,{color:d,fontSize:a,textAlign:S(e.alignment),fontWeight:p.includes("bold")?"bold":"normal",fontStyle:p.includes("italic")?"italic":"normal",textDecorationLine:p.includes("underline")?"underline":"none",lineHeight:parseFloat(e.descriptionLineHeight||"1")*a}],children:e.descriptionText})]},`body-${e.order}`)},T=e=>{const i=x(e.ctaBoxColor,"#000000"),o=x(e.ctaTextColour,"#FFFFFF"),n=x(e.ctaBackgroundColor,"#FFFFFF"),r=parseFloat(e.ctaBorderRadius||"5"),s=parseFloat(e.ctaHeight||"50"),a=parseFloat(e.ctaWidth||"100"),l=parseFloat(e.ctaFontSize||"14"),c=e.ctaFontDecoration||"";return z.jsx(t.View,{style:[le.ctaContainer,{backgroundColor:n,paddingLeft:parseFloat(e.paddingLeft||"0"),paddingRight:parseFloat(e.paddingRight||"0"),paddingTop:parseFloat(e.paddingTop||"0"),paddingBottom:parseFloat(e.paddingBottom||"0"),justifyContent:C(e.alignment)}],children:z.jsx(t.TouchableOpacity,{onPress:()=>v(e.ctaLink),activeOpacity:1,style:[le.ctaButton,{backgroundColor:i,borderRadius:r,height:s,width:e.ctaFullWidth?"100%":a}],children:z.jsx(t.Text,{style:[le.ctaText,{color:o,fontSize:l,fontWeight:c.includes("bold")?"bold":"normal",fontStyle:c.includes("italic")?"italic":"normal",textDecorationLine:c.includes("underline")?"underline":"none"}],children:e.ctaText||"Click"})})},`cta-${e.order}`)},I=()=>{const e=y.find(e=>"left"===e.position),i=y.find(e=>"right"===e.position);return e||i?z.jsxs(t.View,{style:le.ctaRow,children:[z.jsx(t.View,{style:le.ctaRowItem,children:e&&T(e)}),z.jsx(t.View,{style:le.ctaRowItem,children:i&&T(i)})]},"cta-row"):null};if(!h||!u)return null;const R=parseFloat(h.cornerRadius||"16"),O=!0===(null==g?void 0:g.overlayButton),P=y.filter(e=>"center"===e.position||!e.position);return z.jsx(t.Modal,{visible:o,transparent:!0,animationType:"none",onRequestClose:w,children:z.jsxs(t.View,{style:le.overlay,children:[z.jsx(t.Animated.View,{style:[le.backdrop,{opacity:l}],children:z.jsx(t.TouchableOpacity,{style:le.backdropTouchable,onPress:()=>{w()},activeOpacity:1})}),z.jsxs(t.Animated.View,{style:[le.bottomSheetContainer,{borderTopLeftRadius:R,borderTopRightRadius:R,transform:[{translateY:a}]}],...m.panHandlers,children:[z.jsx(t.ScrollView,{style:le.scrollView,showsVerticalScrollIndicator:!1,bounces:!1,onContentSizeChange:(e,t)=>{!c&&t>0&&d(!0)},children:O?z.jsxs(t.View,{style:le.overlayContainer,children:[g&&k(g),z.jsxs(t.View,{style:le.overlayContent,children:[f.map(j),I(),P.map(T)]})]}):z.jsxs(t.View,{style:le.normalContainer,children:[g&&k(g),f.map(j),I(),P.map(T)]})}),"true"===h.enableCrossButton&&z.jsx(t.TouchableOpacity,{onPress:w,style:le.closeButton,children:z.jsx(t.Image,{source:require("../assets/images/close.png"),style:le.closeIcon})})]})]})})}const le=t.StyleSheet.create({overlay:{flex:1,justifyContent:"flex-end"},backdrop:{...t.StyleSheet.absoluteFillObject,backgroundColor:"rgba(0, 0, 0, 0.5)"},backdropTouchable:{flex:1},bottomSheetContainer:{backgroundColor:"white",shadowColor:"#000",shadowOffset:{width:0,height:-2},shadowOpacity:.25,shadowRadius:3.84,elevation:5,overflow:"hidden",borderTopLeftRadius:16,borderTopRightRadius:16},dragHandle:{width:40,height:4,backgroundColor:"#D1D5DB",borderRadius:2,alignSelf:"center",marginTop:8,marginBottom:8},scrollView:{flexGrow:0,flexShrink:1},overlayContainer:{position:"relative"},overlayContent:{position:"absolute",bottom:0,left:0,right:0,backgroundColor:"transparent"},normalContainer:{backgroundColor:"white"},imageContainer:{backgroundColor:"transparent",width:"100%",alignItems:"center"},image:{width:"100%",height:void 0,aspectRatio:1},bodyContainer:{width:"100%"},titleText:{width:"100%"},descriptionText:{width:"100%"},ctaContainer:{width:"100%",alignItems:"center"},ctaRow:{flexDirection:"row",width:"100%"},ctaRowItem:{flex:1},ctaButton:{justifyContent:"center",alignItems:"center"},ctaText:{textAlign:"center"},closeButton:{position:"absolute",top:16,right:16,width:32,height:32,borderRadius:16,backgroundColor:"rgba(0, 0, 0, 0.3)",justifyContent:"center",alignItems:"center",zIndex:1e3},closeIcon:{width:24,height:24,tintColor:"white"}});class ce{static setup(e,t){const i=de.getState();i.setScreenCaptureEnabled(e),i.setScreenName(t)}static getIsCapturing(){return de.getState().isCapturing}static getIsScreenCaptureEnabled(){return de.getState().isScreenCaptureEnabled}static addLayoutInfo(e,t){const i=this.layoutData.findIndex(t=>t.id===e),o={id:e,frame:t};i>=0?this.layoutData[i]=o:this.layoutData.push(o)}static clearLayoutData(){this.layoutData=[]}static async takeScreenshot(){try{const e=de.getState().screenName;if(!e)return console.error("Screen name is not set. Cannot identify elements."),!1;this.setIsCapturing(!0),await new Promise(e=>setTimeout(e,100));const t=await a.captureScreen({format:"png",quality:1}),i=`screen_capture_${Date.now()}.png`,o=`${b.default.TemporaryDirectoryPath}/${i}`;await b.default.copyFile(t,o);const n=JSON.stringify(this.layoutData);return console.log("Layout data:",this.layoutData),await this.identifyElements({screenName:e,screenshotPath:o,children:n}),!0}catch(e){return console.error("Screenshot failed:",e),!1}finally{this.setIsCapturing(!1)}}static dispose(){this.setIsCapturing(!1),this.setup(!1,null),this.clearLayoutData()}static async identifyElements({screenName:e,screenshotPath:t,children:i}){try{const o=await W(),n=$();if(!o||!n)return void console.error("Error in identifyElements. Access token or user ID not found");const r=new FormData;r.append("screenName",e),r.append("user_id",n),r.append("children",i),r.append("screenshot",{uri:`file://${t}`,type:"image/png",name:"screenshot.png"});const s=await fetch("https://backend.appstorys.com/api/v1/appinfo/identify-elements/",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"multipart/form-data"},body:r});if(200===s.status||201===s.status||204===s.status)console.log("Elements identified successfully");else{const e=await s.text();console.error(`Server error: ${s.status} ${e}`)}await b.default.unlink(t)}catch(e){console.error("Exception in identifyElements:",e)}}static setIsCapturing(e){de.getState().setIsCapturing(e)}}ce.layoutData=[];const de=L(e=>({screenName:null,isCapturing:!1,isScreenCaptureEnabled:!1,setScreenName:t=>e({screenName:t}),setIsCapturing:t=>e({isCapturing:t}),setScreenCaptureEnabled:t=>e({isScreenCaptureEnabled:t})})),ue=e.createContext({register:(e,t)=>{},unregister:e=>{},measure:async e=>null,measureAll:async()=>[]});function he(){const i=de(e=>e.isScreenCaptureEnabled),o=de(e=>e.isCapturing),n=de(e=>e.screenName),r=function(){const{measureAll:i}=e.useContext(ue);return e.useCallback(async()=>{try{if(ce.getIsCapturing())return void t.Alert.alert("Info","Capture is already in progress");const e=await i();ce.clearLayoutData(),e.forEach(({id:e,size:t,position:i})=>{ce.addLayoutInfo(e,{x:i.x,y:i.y,width:t.width,height:t.height})}),await ce.takeScreenshot()?t.Alert.alert("Success","Screen captured successfully"):t.Alert.alert("Error","Failed to capture screen")}catch(e){t.Alert.alert("Error",`Failed to capture screen: ${e}`)}},[])}();return i&&n?z.jsx(t.View,{style:pe.elevationContainer,children:z.jsx(t.TouchableOpacity,{activeOpacity:.7,onPress:r,style:pe.buttonContainer,disabled:o,children:o?z.jsx(t.ActivityIndicator,{}):z.jsx(t.Text,{style:pe.buttonText,children:"Capture Screen"})})}):null}const pe=t.StyleSheet.create({elevationContainer:{position:"absolute",bottom:20,right:20,borderRadius:12,elevation:4,backgroundColor:"white",shadowColor:"#000",shadowOffset:{width:0,height:2},shadowOpacity:.2,shadowRadius:4,zIndex:1e5},buttonContainer:{padding:16,borderRadius:12,backgroundColor:"white"},buttonText:{fontSize:16,color:"#222",textAlign:"center"}});function ge(){var i,o,n,r;const[s,a]=e.useState(null),l=M("FLT"),c=(null===(i=Y("FLT"))||void 0===i?void 0:i.bottom)||0,[d,u]=e.useState(parseInt("0")),[h,p]=e.useState(parseInt("0")),[g,f]=e.useState(parseInt("0")),[y,m]=e.useState(parseInt("0"));return e.useEffect(()=>{l&&(X("viewed",l.id),E(l.details.image,e=>{a(e),l.details.styling&&(u(parseInt(l.details.styling.bottomLeftRadius||"0")),p(parseInt(l.details.styling.bottomRightRadius||"0")),f(parseInt(l.details.styling.topLeftRadius||"0")),m(parseInt(l.details.styling.topRightRadius||"0")))}))},[l]),z.jsx(z.Fragment,{children:l&&l.details&&""!==l.details.image&&z.jsx(t.View,{style:{position:"absolute",left:"left"==l.details.position?16:void 0,right:"right"==l.details.position||""==l.details.position||null==l.details.position?16+(null!==(o=l.details.width)&&void 0!==o?o:60):void 0,bottom:20+c,justifyContent:"flex-end"},children:z.jsx(t.TouchableOpacity,{activeOpacity:1,onPress:()=>{l.details.link&&(X("clicked",l.id),t.Linking.openURL(l.details.link))},style:{width:null!==(n=l.details.width)&&void 0!==n?n:60,height:null!==(r=l.details.height)&&void 0!==r?r:60,alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",overflow:"hidden",borderBottomLeftRadius:d,borderBottomRightRadius:h,borderTopLeftRadius:g,borderTopRightRadius:y},children:z.jsx(t.Image,{source:{uri:`file://${s}`},style:fe.image})})})})}const fe=t.StyleSheet.create({image:{width:"100%",height:"100%",resizeMode:"cover"}});function ye(){var i;const[o,n]=e.useState(!1),[r,s]=e.useState(null),[a,l]=e.useState(200),c=M("MOD"),d=(null==c?void 0:c.details)||null,u=null===(i=null==d?void 0:d.modals)||void 0===i?void 0:i[0],h=null==u?void 0:u.url,p=e.useMemo(()=>h?h.toLowerCase().endsWith(".gif")?"gif":h.toLowerCase().endsWith(".json")?"lottie":"image":"image",[h]);e.useEffect(()=>{(null==c?void 0:c.id)&&d&&h&&(n(!0),X("viewed",c.id),"lottie"!==p&&E(h,e=>{s(e),t.Image.getSize(`file://${e}`,(e,t)=>{l(f*(t/e))},e=>{console.error("Failed to get image size:",e)})}))},[null==c?void 0:c.id,d,h,p]);const g=()=>{n(!1)},f=parseFloat((null==u?void 0:u.size)||"200"),y=parseFloat((null==u?void 0:u.borderRadius)||"12"),m=parseFloat((null==u?void 0:u.backgroundOpacity)||"0.3");return d&&o&&c&&h?z.jsx(t.Modal,{visible:o,transparent:!0,animationType:"fade",onRequestClose:g,children:z.jsx(t.TouchableWithoutFeedback,{onPress:g,children:z.jsx(t.View,{style:[me.overlay,{backgroundColor:`rgba(0, 0, 0, ${m})`}],children:z.jsxs(t.View,{style:me.modalContainer,children:[z.jsx(t.TouchableOpacity,{activeOpacity:1,onPress:()=>{(null==c?void 0:c.id)&&X("clicked",c.id);const e=null==u?void 0:u.link;e&&(e=>{if(!e)return!1;try{return e.startsWith("http://")||e.startsWith("https://")}catch{return!1}})(e)&&t.Linking.openURL(e).catch(e=>console.error("Failed to open URL:",e)),g()},style:me.mediaContainer,children:(()=>{const e={width:f,height:a,borderRadius:y};{if(!r)return null;const i=(null==r?void 0:r.startsWith("file://"))||(null==r?void 0:r.startsWith("http"))?{uri:r}:{uri:`file://${r}`};return z.jsx(t.Image,{source:i,style:[e,me.mediaContent],resizeMode:"contain"})}})()}),z.jsx(t.TouchableOpacity,{onPress:g,style:me.closeButton,activeOpacity:1,children:z.jsx(t.Image,{source:require("../assets/images/close.png"),style:me.closeIcon})})]})})})}):null}const me=t.StyleSheet.create({overlay:{flex:1,justifyContent:"center",alignItems:"center"},modalContainer:{position:"relative",padding:8},mediaContainer:{justifyContent:"center",alignItems:"center"},mediaContent:{},closeButton:{position:"absolute",top:0,right:0,width:24,height:24,borderRadius:12,backgroundColor:"black",justifyContent:"center",alignItems:"center"},closeIcon:{width:10,height:10,tintColor:"white"}}),be=new d.EventEmitter,we="TOGGLE_PIP";async function ve(e,t,i,o){try{const n=await W();if(!n)throw new Error("Access token not found");const r={campaign_id:e,user_id:$(),event_type:t};i&&(r.story_slide=i),o&&(r.widget_image=o);if(!(await fetch("https://backend.appstorys.com/api/v1/users/track-action/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(r)})).ok)throw new Error("Something went wrong")}catch(e){console.log(e)}}function xe({params:i,onClose:o,onMinimize:n}){const{height:r,width:s}=t.Dimensions.get("window"),[a,c]=e.useState(!1);return z.jsxs(t.View,{style:{flex:1,backgroundColor:"black"},children:[z.jsx(t.View,{style:{flex:1},children:z.jsx(C.default,{repeat:!0,resizeMode:"contain",muted:a,controls:!1,source:{uri:i.largeVideoUrl},style:{position:"absolute",overflow:"hidden",top:0,left:0,bottom:0,right:0}})}),z.jsx(t.TouchableOpacity,{onPress:o,style:{flex:1,position:"absolute",top:"ios"===t.Platform.OS?.1*r:25,right:25},children:z.jsx(t.Image,{source:require("../../assets/images/close.png"),style:{height:20,width:20}})}),z.jsx(t.TouchableOpacity,{onPress:()=>{c(!a)},style:{flex:1,position:"absolute",top:"ios"===t.Platform.OS?.1*r:22,right:68},children:z.jsx(t.Image,{source:a?require("../../assets/images/mute.png"):require("../../assets/images/volume.png"),style:{height:25,width:25}})}),z.jsx(t.TouchableOpacity,{onPress:()=>{var e;e=!0,be.emit(we,e),n()},style:{flex:1,position:"absolute",top:"ios"===t.Platform.OS?.1*r:25,left:25},children:z.jsx(t.Image,{source:require("../../assets/images/minimize.png"),style:{height:22,width:22}})}),null!=i.link&&""!=i.link&&z.jsx(t.View,{style:{display:"flex",position:"absolute",width:s,justifyContent:"center",alignItems:"center",bottom:parseInt(i.styling.marginBottom)||20,left:parseInt(i.styling.marginLeft)||20,right:parseInt(i.styling.marginRight)||20},children:z.jsx(l.Pressable,{style:{backgroundColor:i.styling.ctaButtonBackgroundColor,borderRadius:parseInt(i.styling.cornerRadius)||12},onPress:()=>{i.link&&t.Linking.openURL(i.link),ve(i.id,"CLK"),X("clicked",i.id)},children:z.jsx(t.Text,{style:{color:i.styling.ctaButtonTextColor,fontWeight:"600",textAlign:"center",textAlignVertical:"center",height:45,paddingVertical:10,paddingHorizontal:25},children:i.button_text})})})]})}function Se(){var i,o;const{width:n,height:r}=t.Dimensions.get("window"),s=M("PIP"),a=Y("PIP"),c=(null==a?void 0:a.top)||0,d=(null==a?void 0:a.bottom)||0;e.useEffect(()=>{const e=(t=e=>{v(e)},be.on(we,t),()=>{be.off(we,t)});var t;return()=>{e()}},[]);const[u,h]=e.useState(null);let p=null!=s&&null!=s.details.height?s.details.height+20:220,g=null!=s&&null!=s.details.width?s.details.width:140,f=null!=s&&null!=s.details.height?s.details.height:200;const y=n-g-20,m=r-(d+f)-20,b="ios"===t.Platform.OS?60+c:20+c,[w,v]=e.useState(!0),[x,S]=e.useState(""),[k,j]=e.useState(""),[T,I]=e.useState(!0),R=null!=s&&"right"==s.details.position?null!=s.details.width?n-(s.details.width+20):n-160:20,O=r-(d+p),P=e.useRef(new t.Animated.ValueXY({x:0,y:0})).current;e.useEffect(()=>{P.setOffset({x:R,y:O})},[]),e.useEffect(()=>{s&&s.id&&(X("viewed",s.id),E(s.details.small_video,S),E(s.details.large_video,j))},[s]);const _=()=>{v(!1)},D=()=>{h(null),v(!0)};function V(){if(s&&(null!=s.details.large_video||""!=s.details.large_video)){_();const e=s.details.link;h({id:s.id,link:e,button_text:s.details.button_text,largeVideoUrl:`file://${k}`,styling:s.details.styling}),X("viewed",s.id)}}const F=e.useRef({x:R,y:O}),L=l.Gesture.Pan().minDistance(10).onUpdate(e=>{P.setValue({x:e.translationX,y:e.translationY})}).onEnd(e=>{const t=F.current.x+e.translationX,i=F.current.y+e.translationY,o=(n=t,r=i,{x:Math.min(Math.max(n,20),y),y:Math.min(Math.max(r,b),m)});var n,r;F.current=o,P.setOffset(o),P.setValue({x:0,y:0})}).simultaneousWithExternalGesture();return z.jsxs(t.View,{style:[t.StyleSheet.absoluteFill,{zIndex:999998,top:c,bottom:d}],pointerEvents:"box-none",children:[s&&w&&z.jsx(l.GestureDetector,{gesture:L,children:z.jsxs(t.Animated.View,{style:{backgroundColor:"black",width:null!==(i=s.details.width)&&void 0!==i?i:140,height:null!==(o=s.details.height)&&void 0!==o?o:200,position:"absolute",borderRadius:15,display:"flex",flexDirection:"row",zIndex:999999,elevation:999999,transform:[{translateX:P.x},{translateY:t.Animated.subtract(P.y,new t.Animated.Value(c))}]},children:[z.jsx(t.Pressable,{onPress:V,style:{flex:1},children:s.details.small_video&&s.details.large_video&&z.jsx(C.default,{repeat:!0,resizeMode:"contain",muted:T,controls:!1,source:{uri:`file://${x}`},style:{borderRadius:15,position:"absolute",overflow:"hidden",top:0,left:0,bottom:0,right:0}})}),z.jsx(t.Pressable,{onPress:_,style:{padding:7,position:"absolute",top:5,right:5,backgroundColor:"black",borderRadius:20,display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e6,elevation:1e6},children:z.jsx(t.Image,{source:require("../../assets/images/close.png"),style:{height:9,width:9}})}),z.jsx(t.Pressable,{onPress:()=>{I(!T)},style:{padding:5,position:"absolute",top:5,right:null!=s.details.width?s.details.width-30:110,backgroundColor:"black",borderRadius:20,display:"flex",zIndex:1e6,elevation:1e6},children:z.jsx(t.Image,{source:T?require("../../assets/images/mute.png"):require("../../assets/images/volume.png"),style:{height:16,width:16}})}),null!=s.details.large_video&&""!=s.details.large_video&&z.jsx(t.Pressable,{onPress:V,style:{padding:7,position:"absolute",bottom:7,right:5,backgroundColor:"black",borderRadius:20,display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e6,elevation:1e6},children:z.jsx(t.Image,{source:require("../../assets/images/enlarge.png"),style:{height:10,width:10}})})]})}),z.jsx(t.Modal,{animationType:"fade",transparent:!1,visible:!!u,onRequestClose:D,children:u&&z.jsx(xe,{params:u,onClose:D,onMinimize:D})})]})}const Ce=require("../../assets/images/close.png"),ke=require("../../assets/images/share.png");function je({params:i,onClose:o}){var n,r,s,a,l,c,d,u,h,p,g,f,y,m,b;const{height:w,width:v}=t.Dimensions.get("window"),[x,S]=e.useState([]),[k,j]=e.useState(0),[T,I]=e.useState(0),[R,O]=e.useState(0),[P,_]=e.useState(5),[E,D]=e.useState(!1);e.useEffect(()=>{i&&(j(i.initialGroupIndex),V(i.initialGroupIndex),console.log(P))},[i]);const V=e=>{var t;if(!(null===(t=null==i?void 0:i.slideData)||void 0===t?void 0:t.details[e]))return void B();const o=i.slideData.details[e].slides.map(e=>({...e,finish:0}));F.setValue(0),S(o),I(0),O(0)},F=e.useRef(new t.Animated.Value(0)).current,L=e=>{var o,n,r;(null===(o=null==i?void 0:i.slideData)||void 0===o?void 0:o.details)&&i.slideData.details[k]&&i.slideData.details[k].slides&&i.slideData.details[k].slides[R]&&i.slideData.details[k].slides[R].id&&(null==i?void 0:i.campaignId)&&(X("viewed",i.campaignId,{story_slide:null!==(r=null===(n=i.slideData.details[k].slides[R])||void 0===n?void 0:n.id)&&void 0!==r?r:""}),O(R+1)),t.Animated.timing(F,{toValue:1,duration:e,useNativeDriver:!1}).start(({finished:e})=>{e&&A()})},A=()=>{if(T!==x.length-1){let e=[...x];e[T]&&(e[T].finish=1),S(e),I(T+1),F.setValue(0)}else{const e=k+1;e<i.slideData.details.length?(j(e),V(e)):B()}},B=()=>{console.log("Close function called"),F.setValue(0),o()},$=e.useRef(t.PanResponder.create({onMoveShouldSetPanResponder:(e,t)=>t.dy>10,onPanResponderRelease:(e,t)=>{t.dy>150&&B()}})).current;return i?z.jsxs(t.View,{style:{flex:1,backgroundColor:"black",paddingTop:"ios"===t.Platform.OS?.07*w:.02*w,paddingBottom:"ios"===t.Platform.OS?.07*w:.02*w},...$.panHandlers,children:[x&&0!==x.length&&"string"==typeof(null===(n=x[T])||void 0===n?void 0:n.image)&&""!==(null===(r=x[T])||void 0===r?void 0:r.image)&&z.jsx(t.Image,{source:{uri:null===(s=x[T])||void 0===s?void 0:s.image},onLoadEnd:()=>{F.setValue(0),L(5e3)},style:{height:"100%",width:v,resizeMode:"contain",top:0}}),x&&0!==x.length&&"string"==typeof(null===(a=x[T])||void 0===a?void 0:a.video)&&""!==(null===(l=x[T])||void 0===l?void 0:l.video)&&z.jsx(C.default,{source:{uri:null===(c=x[T])||void 0===c?void 0:c.video},style:{height:"100%",width:v},resizeMode:"contain",muted:E,controls:!1,onLoad:e=>{console.log("Video loaded with duration:",e.duration),_(e.duration),F.setValue(0),L(1e3*e.duration)},onError:e=>console.error("Video error:",e),onEnd:A,paused:!1}),z.jsx(t.View,{style:{width:v-5,position:"absolute",top:"ios"===t.Platform.OS?.08*w:.03*w,justifyContent:"space-evenly",alignItems:"center",flexDirection:"row"},children:x.map((e,i)=>{var o,n;return z.jsx(t.View,{style:{flexDirection:"row",flex:1,height:3,backgroundColor:"grey",marginLeft:5,borderRadius:2},children:z.jsx(t.Animated.View,{style:{flex:T===i?F:null!==(n=null===(o=x[i])||void 0===o?void 0:o.finish)&&void 0!==n?n:1,height:3,borderRadius:2,backgroundColor:"rgba(211, 202, 202, 1)"}})},i)})}),z.jsx(t.View,{style:{width:v,height:50,flexDirection:"row",justifyContent:"space-between",position:"absolute",top:"ios"===t.Platform.OS?.094*w:.045*w},children:z.jsxs(t.View,{style:{flexDirection:"row",display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",paddingRight:26,paddingLeft:20},children:[z.jsxs(t.View,{style:{display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"row"},children:[(null===(d=null==i?void 0:i.slideData)||void 0===d?void 0:d.details)&&i.slideData.details[k]&&i.slideData.details[k].thumbnail&&z.jsx(t.Image,{source:{uri:null===(u=null==i?void 0:i.slideData)||void 0===u?void 0:u.details[k].thumbnail},style:{width:40,height:40,borderRadius:20}}),(null===(h=null==i?void 0:i.slideData)||void 0===h?void 0:h.details)&&i.slideData.details[k]&&i.slideData.details[k].name&&z.jsx(t.Text,{style:{marginLeft:12,fontSize:15,fontWeight:"500",color:"white"},children:i.slideData.details[k].name})]}),z.jsxs(t.View,{style:{display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"row",bottom:2},children:[x&&x[T]&&(null===(p=x[T])||void 0===p?void 0:p.video)&&z.jsx(t.TouchableOpacity,{onPress:()=>{D(!E)},style:{},children:z.jsx(t.Image,{source:E?require("../../assets/images/mute.png"):require("../../assets/images/volume.png"),style:{height:24,width:24,marginVertical:16,marginRight:16}})}),x&&x[T]&&(null===(g=x[T])||void 0===g?void 0:g.button_text)&&(null===(f=x[T])||void 0===f?void 0:f.link)&&z.jsx(t.TouchableOpacity,{onPress:async()=>{var e,i,o;try{await t.Share.share({message:"Check this out: "+(null===(e=x[T])||void 0===e?void 0:e.link),url:null!==(o=null===(i=x[T])||void 0===i?void 0:i.content)&&void 0!==o?o:void 0})}catch(e){console.error("Error sharing content: ",e)}},style:{},children:z.jsx(t.Image,{source:ke,style:{height:20,width:20,marginVertical:16,marginRight:16}})}),z.jsx(t.TouchableOpacity,{onPress:B,style:{},children:z.jsx(t.Image,{source:Ce,style:{height:18,width:18}})})]})]})}),z.jsxs(t.View,{style:{marginTop:.15*w,width:v,height:w,position:"absolute",top:0,flexDirection:"row",justifyContent:"space-between"},children:[z.jsx(t.TouchableOpacity,{style:{width:"50%",height:"100%"},onPress:()=>{if(T>0){let e=[...x];e[T]&&(e[T].finish=0),S(e),F.setValue(0),I(T-1)}else if(k>0){const e=k-1;j(e),V(e),I(0)}}}),z.jsx(t.TouchableOpacity,{style:{width:"50%",height:"100%"},onPress:A})]}),x&&x[T]&&(null===(y=x[T])||void 0===y?void 0:y.button_text)&&(null===(m=x[T])||void 0===m?void 0:m.link)&&z.jsx(t.View,{style:{position:"absolute",bottom:.037*w,width:v,display:"flex",justifyContent:"center",alignItems:"center"},children:z.jsx(t.TouchableOpacity,{activeOpacity:1,onPress:()=>{var e,o,n,r;"string"==typeof(null===(e=x[T])||void 0===e?void 0:e.link)&&t.Linking.openURL(null===(o=x[T])||void 0===o?void 0:o.link),i&&i.campaignId&&X("clicked",i.campaignId,{story_slide:null!==(r=null===(n=x[T])||void 0===n?void 0:n.id)&&void 0!==r?r:""})},children:z.jsx(t.View,{style:{backgroundColor:"white",borderRadius:30},children:z.jsx(t.Text,{style:{color:"black",fontWeight:"600",textAlign:"center",textAlignVertical:"center",height:45,paddingVertical:10,paddingHorizontal:25},children:null===(b=x[T])||void 0===b?void 0:b.button_text})})})})]}):z.jsx(t.View,{style:{backgroundColor:"black"},children:z.jsx(t.Text,{style:{color:"white",fontSize:14},children:"No data available"})})}const Te="viewed_stories",Ie="#808080";function Re(){const[i,o]=e.useState(new Set),[n,r]=e.useState(null),s=M("STR"),a=e.useMemo(()=>{if(!(null==s?void 0:s.details))return null;const e=[...s.details].reverse();return{id:s.id,campaign_type:"STR",details:e}},[s]);e.useEffect(()=>{(async()=>{try{const e=await j.default.getItem(Te);e&&o(new Set(JSON.parse(e)))}catch(e){console.error("Error loading viewed stories:",e)}})()},[]);const l=e.useMemo(()=>{if(!(null==a?void 0:a.details))return null;const e=[...a.details].sort((e,t)=>{const o=i.has(e.id);return o===i.has(t.id)?0:o?1:-1});return{id:a.id,campaign_type:"STR",details:e}},[a,i]);function c(e,t){(async e=>{const t=new Set(i);t.add(e),o(t);try{await j.default.setItem(Te,JSON.stringify(Array.from(t)))}catch(e){console.error("Error saving viewed stories:",e)}})(e.details[t].id),r({slideData:e,campaignId:e.id,initialGroupIndex:t})}return e.useEffect(()=>{(null==l?void 0:l.id)&&X("viewed",l.id)},[null==l?void 0:l.id]),l?z.jsxs(t.View,{style:Oe.container,children:[z.jsx(t.ScrollView,{horizontal:!0,showsHorizontalScrollIndicator:!1,children:l.details.map((e,o)=>{const n=i.has(e.id);return z.jsx(t.View,{style:Oe.storyContainer,children:z.jsxs(t.View,{style:Oe.storyWrapper,children:[z.jsx(t.TouchableWithoutFeedback,{onPress:()=>{c(l,o),X("clicked",l.id)},children:z.jsx(t.View,{style:[Oe.thumbnailContainer,{borderColor:n?Ie:e.ringColor}],children:z.jsx(t.Image,{source:{uri:e.thumbnail},style:[Oe.thumbnail,{opacity:n?.6:1}]})})}),z.jsx(t.Text,{style:{marginTop:6,fontSize:14,fontWeight:"500",color:n?Ie:e.nameColor,textAlign:"center"},children:e.name})]})},e.id)})}),z.jsx(t.Modal,{animationType:"slide",transparent:!1,visible:!!n,onRequestClose:()=>r(null),children:n&&z.jsx(je,{params:n,onClose:()=>r(null)})})]}):null}const Oe=t.StyleSheet.create({container:{width:"100%",position:"relative",justifyContent:"flex-start",alignItems:"center",flexDirection:"row"},storyContainer:{flexDirection:"row",flex:1,height:135,width:98,backgroundColor:"rgba(255, 255, 255, 0)",justifyContent:"center"},storyWrapper:{marginTop:6,flexDirection:"column",alignItems:"center"},thumbnailContainer:{height:82,width:82,borderRadius:45,borderWidth:2,justifyContent:"center",alignItems:"center"},thumbnail:{width:65,height:65,borderRadius:35,overflow:"hidden"}});class Pe extends d.EventEmitter{constructor(){super(),this.webSocket=null,this.isConnected=!1,this.TAG="WebSocketClient",this.setMaxListeners(100)}connect(e){try{const t=new URL(e.url);return this.webSocket=new WebSocket(t.toString(),[],{headers:{Authorization:`Bearer ${e.token}`,"Session-ID":e.sessionID}}),this.webSocket.onopen=()=>{this.isConnected=!0,this.emit("open")},this.webSocket.onmessage=e=>{this.emit("message",e.data)},this.webSocket.onclose=e=>{this.isConnected=!1,this.emit("close",e)},this.webSocket.onerror=e=>{this.isConnected=!1,this.emit("error",e)},!0}catch(e){return console.error(`${this.TAG}: Error connecting to WebSocket:`,e),!1}}isConnectedStatus(){return this.isConnected&&null!==this.webSocket}disconnect(){try{this.webSocket&&(this.webSocket.close(1e3,"Disconnecting"),this.webSocket=null),this.isConnected=!1}catch(e){console.error(`${this.TAG}: Error disconnecting WebSocket:`,e)}}onMessage(e){return this.on("message",e),()=>this.off("message",e)}}function _e({data:e,position:i,size:o,tooltipPosition:n,styling:r,onClose:s,onTooltipClick:a}){const l=t.Dimensions.get("window"),c={position:"absolute",left:n.tooltipX,top:"bottom"===n.placement?n.tooltipY:i.y-r.highlightPadding-r.arrowHeight-r.tooltipHeight,width:r.tooltipWidth,height:r.tooltipHeight,borderRadius:r.cornerRadius,backgroundColor:"white",overflow:"hidden"};return z.jsxs(t.View,{style:ze.container,children:[(()=>{const e={x:i.x-r.highlightPadding,y:i.y-r.highlightPadding,width:o.width+2*r.highlightPadding,height:o.height+2*r.highlightPadding};return z.jsx(t.TouchableOpacity,{style:ze.backdrop,onPress:s,activeOpacity:1,children:z.jsxs(h.Svg,{width:l.width,height:l.height,style:t.StyleSheet.absoluteFillObject,children:[z.jsx(h.Defs,{children:z.jsxs(h.Mask,{id:"mask",children:[z.jsx(h.Rect,{width:l.width,height:l.height,fill:"white"}),z.jsx(h.Rect,{x:e.x,y:e.y,width:e.width,height:e.height,rx:r.highlightRadius,ry:r.highlightRadius,fill:"black"})]})}),z.jsx(h.Rect,{width:l.width,height:l.height,fill:"black",opacity:.5,mask:"url(#mask)"})]})})})(),(()=>{const e={position:"absolute",left:n.arrowX-r.arrowWidth/2,top:"bottom"===n.placement?i.y+o.height+r.highlightPadding:i.y-r.highlightPadding-r.arrowHeight};return z.jsx(t.View,{style:e,children:z.jsx(h.Svg,{width:r.arrowWidth,height:r.arrowHeight,children:z.jsx(h.Path,{d:"top"===n.placement?`M0,0 L${r.arrowWidth/2},${r.arrowHeight} L${r.arrowWidth},0 Z`:`M0,${r.arrowHeight} L${r.arrowWidth/2},0 L${r.arrowWidth},${r.arrowHeight} Z`,fill:"white"})})})})(),z.jsx(t.TouchableOpacity,{style:c,onPress:a,activeOpacity:.9,children:z.jsx(t.Image,{source:{uri:e.url},style:ze.tooltipImage,resizeMode:"cover"})})]})}const ze=t.StyleSheet.create({container:{...t.StyleSheet.absoluteFillObject,zIndex:1e3},backdrop:{...t.StyleSheet.absoluteFillObject},tooltipImage:{width:"100%",height:"100%"}});class Ee{constructor(){this.tooltips=[],this.currentTooltipIndex=0,this.isProcessing=!1}static getInstance(){return Ee.instance||(Ee.instance=new Ee),Ee.instance}setMeasurementFunction(e){this.measure=e}setTooltipHandlers(e,t){this.onShowTooltip=e,this.onHideTooltip=t}async processTooltips(e){if(!this.measure||!this.onShowTooltip||!this.onHideTooltip)return void console.warn("TooltipManager not fully initialized. Missing measurement function or handlers.");const t=e.filter(e=>"TTP"===e.campaign_type);if(0===t.length)return;const i=t[0];this.reset(),this.tooltips=i.details.tooltips;try{this.tooltips.length>0&&setTimeout(()=>{this.showNextTooltip(i.id)},1e3)}catch(e){console.error("Error measuring elements for tooltips:",e)}}reshowCurrentTooltip(e){return this.isProcessing=!1,this.showNextTooltip(e)}reset(){var e;this.tooltips=[],this.currentTooltipIndex=0,this.isProcessing=!1,null===(e=this.onHideTooltip)||void 0===e||e.call(this)}async showNextTooltip(e){if(this.isProcessing||this.currentTooltipIndex>=this.tooltips.length)return;const t=this.tooltips[this.currentTooltipIndex];if(!t)return this.onTooltipClosed(e);const i=await this.measure(null==t?void 0:t.target);if(!i)return this.onTooltipClosed(e);this.isProcessing=!0,this.showOverlay(i,t,e)}onTooltipClosed(e){var t;console.log("Tooltip closed"),null===(t=this.onHideTooltip)||void 0===t||t.call(this),this.currentTooltipIndex++,this.isProcessing=!1,this.currentTooltipIndex<this.tooltips.length?setTimeout(()=>{this.showNextTooltip(e)},300):this.reset()}showOverlay(e,i,o){var n;try{const r=t.Dimensions.get("window"),s={x:e.position.logicalX,y:e.position.logicalY},a={width:e.size.logicalWidth,height:e.size.logicalHeight},l=i.styling,c=parseFloat(l.tooltipDimensions.width),d=parseFloat(l.tooltipDimensions.height),u=parseFloat(l.highlightRadius),h=parseFloat(l.highlightPadding),p=parseFloat(l.tooltipArrow.arrowHeight),g=parseFloat(l.tooltipArrow.arrowWidth),f=parseFloat(l.tooltipDimensions.cornerRadius),y=l.backgroundColor,m=l.enableBackdrop,b=this.calculatePosition({position:s,size:a,screenSize:r,tooltipWidth:c,arrowSize:p,padding:h});X("viewed",o,{tooltip_id:i._id});const w=this.createTooltipComponent({data:i,position:s,size:a,tooltipPosition:b,styling:{tooltipWidth:c,tooltipHeight:d,highlightRadius:u,highlightPadding:h,arrowHeight:p,arrowWidth:g,cornerRadius:f,backgroundColor:y,enableBackdrop:m},campaignId:o});null===(n=this.onShowTooltip)||void 0===n||n.call(this,i.target,w)}catch(e){console.error("Error showing tooltip overlay:",e)}}createTooltipComponent({data:e,position:t,size:i,tooltipPosition:o,styling:n,campaignId:r}){return m.default.createElement(_e,{key:e._id,data:e,position:t,size:i,tooltipPosition:o,styling:n,onClose:()=>this.onTooltipClosed(r),onTooltipClick:()=>this.handleClick(e,r)})}handleClick(e,i){const o=e.clickAction,n=e.deepLinkUrl;X("clicked",i,{tooltip_id:e._id}),"deepLink"===o&&n&&""!==n.trim()&&t.Linking.openURL(n).catch(e=>{console.error("Failed to open URL:",e)}),this.onTooltipClosed(i)}calculatePosition({position:e,size:t,screenSize:i,tooltipWidth:o,arrowSize:n,padding:r}){let s="bottom";const a=e.x+t.width/2;let l=a-o/2,c=e.y+t.height+n+r,d=a;l+o>i.width-10&&(l=i.width-o-10),l<10&&(l=10);const u=l+20,h=l+o-20;d=Math.max(u,Math.min(h,d));return c+100>i.height-10&&(s="top",c=e.y-100-n-r),{tooltipX:l,tooltipY:c,arrowX:d,placement:s}}}let De=null;async function Ve(e,t){try{const i=await fetch("https://users.appstorys.com/validate-account",{method:"POST",body:JSON.stringify({account_id:e,app_id:t}),headers:{Accept:"application/json","Content-Type":"application/json"}});if(i.ok){const e=await i.json(),{access_token:t,refresh_token:o}=e;if(t&&o)return await w.default.setItem("access_token",t),await w.default.setItem("refresh_token",o),!0}return!1}catch(e){return console.log(e),!1}}async function Fe(e){try{const t=A.getState().campaigns;if(!t||0==t.length)return void console.log("No campaigns found");const i=await W();if(!i)return void console.error("Access token not found");const o=await fetch("https://backend.appstorys.com/api/v1/users/track-user/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({user_id:$(),app_id:B(),campaign_list:t,attributes:{...e,...A.getState().attributes}})});o.ok||console.error("Something went wrong");const n=await o.json();n.user_id&&A().setUserId(n.user_id),n.campaigns&&A().setCampaigns(n.campaigns)}catch(e){console.error("Error in verifyUser",e)}}const Le=new k.default;function Ae({appstorys:i,children:o}){const{register:n,unregister:r}=e.useContext(ue),s=e.useRef(null);return e.useEffect(()=>(i&&s.current&&n(i,s.current),()=>{i&&r(i)}),[i,n,r]),z.jsx(t.View,{ref:s,collapsable:!1,onLayout:()=>{return e=i,void Le.emit(`layout_changed_${e}`,e);var e},children:o})}function Be(){const[t,i]=e.useState({content:null,id:null}),o=e.useContext(ue);return e.useEffect(()=>{Ee.getInstance().setTooltipHandlers((e,t)=>i({content:t,id:e}),()=>i({content:null,id:null})),Ee.getInstance().setMeasurementFunction(o.measure)},[o]),e.useEffect(()=>{var e,i;if(t.id)return e=t.id,i=()=>Ee.getInstance().reshowCurrentTooltip(t.id),Le.on(`layout_changed_${e}`,i),()=>{Le.off(`layout_changed_${e}`,i)}},[t.id]),t.content}function $e({children:i}){const o=e.useRef(new Map),n=e.useCallback((e,t)=>{o.current.set(e,t)},[]),r=e.useCallback(e=>{o.current.delete(e)},[]),s=e.useCallback(async()=>new Promise(e=>{const t=[],i=Array.from(o.current.entries());let n=0;if(0===i.length)return e(t);i.forEach(([o,r])=>{r&&"function"==typeof r.measureInWindow?r.measureInWindow((e,i,n,r)=>{t.push(We(o,e,i,n,r))}):console.warn(`Could not measure component with id: ${o}`),n++,n===i.length&&e(t)})}),[]),a=e.useCallback(async e=>{const t=o.current.get(e);return t&&"function"==typeof t.measureInWindow?new Promise(i=>{t.measureInWindow((t,o,n,r)=>{i(We(e,t,o,n,r))})}):null},[]);return z.jsxs(ue.Provider,{value:{register:n,unregister:r,measureAll:s,measure:a},children:[i,z.jsxs(p.SafeAreaView,{style:t.StyleSheet.absoluteFill,pointerEvents:"box-none",children:[z.jsx(K,{}),z.jsx(ge,{}),z.jsx(Se,{}),z.jsx(ie,{}),z.jsx(Be,{}),z.jsx(ee,{}),z.jsx(ae,{}),z.jsx(ye,{}),z.jsx(he,{})]})]})}function We(e,i,o,n,r){const s=t.StatusBar.currentHeight||0,a=t.PixelRatio.get(),l="android"===t.Platform.OS&&t.Platform.Version>=35?s:0;return{id:e,size:{width:n*a,height:r*a,logicalWidth:n,logicalHeight:r},position:{x:i*a,y:(o+l)*a,logicalX:i,logicalY:o+l},pixelRatio:a}}var Me=new class{constructor(){this.isInitializing=!1,this.Stories=Re,this.StoriesScreen=je,this.Floater=ge,this.Pip=Se,this.PipScreen=xe,this.Banner=K,this.CaptureScreenButton=he,this.Survey=ee,this.Csat=ie,this.Widgets=re,this.Modal=ye,this.BottomSheet=ae,this.MeasurementProvider=$e,this.Measurable=Ae}async initialize(e,t,i,o){if(this.isInitializing)throw new Error("Initialization already in progress");this.isInitializing=!0;if(!await Ve(t,e))throw new Error("Account verification failed");{const n=A.getState();n.setAppId(e),n.setAccountId(t),n.setUserId(i),o&&n.setAttributes(o)}this.isInitializing=!1}async trackUser(e){return await this.ensureInitialized(),async function(e){try{const t=await W();if(!t)return void console.error("Error in trackUser. Access token not found");const i={user_id:$(),app_id:B(),attributes:e},o=await fetch("https://backend.appstorys.com/api/v1/users/update-user/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)});o.ok||console.error("Something went wrong:",o.status,o.statusText)}catch(e){console.error("Error in trackUser",e)}}(e)}async trackUserAction(e,t){return await this.ensureInitialized(),ve(e,t)}async verifyUser(e){return await this.ensureInitialized(),Fe(e)}async verifyAccount(e,t){return Ve(e,t)}async captureSurveyResponse(e,t,i){return await this.ensureInitialized(),Z(e,t,i)}async captureCsatResponse(e,t,i,o){return await this.ensureInitialized(),te(e,t,i,o)}async trackEvent(e,t,i){return await this.ensureInitialized(),X(e,t,i)}async setUserProperties(e){return await this.ensureInitialized(),async function(e){try{const t=await W(),i=$();if(!t||!i)return void console.warn("Missing accessToken or userId");const o=await N(),n={user_id:i,attributes:{...e||{},...o},silentUpdate:!0};console.log("ðŸ“¤ Sending setUserProperties body:",JSON.stringify(n,null,2));const r=await G({url:"https://users.appstorys.com/track-user",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:n});console.log("ðŸ“¥ setUserProperties request queued or sent:",r)}catch(e){console.error("âŒ Error in setUserProperties:",e)}}(e)}async ensureInitialized(){for(;this.isInitializing;)await new Promise(e=>setTimeout(e,100));const e=A.getState();if(!e.userId||!e.appId||!e.accountId)throw new Error("AppStorys not initialized. Call initialize() first.")}async trackScreen(e,t){await this.ensureInitialized(),await async function(e,t){const i=await new Promise(async t=>{try{const i=await W();if(!i)return console.error("Access token not found"),t(null);const o=await fetch("https://users.appstorys.com/track-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({user_id:$(),screenName:e,attributes:{}})});if(!o.ok)return t(null);const n=await o.json();de.getState().setScreenCaptureEnabled(n.screen_capture_enabled),null==De||De.disconnect(),De=new Pe,De.connect(n.ws),De.onMessage(e=>{try{const i=JSON.parse(e);i&&(null==De||De.disconnect(),t(i))}catch(e){t(null)}})}catch(e){console.error("Error in trackScreen",e),t(null)}});if(i){console.log(i),ce.setup(i.metadata.screen_capture_enabled,e);const o=i.campaigns||[];if(o.length>0){const e=A.getState();e.setCampaigns(o),e.setScreenOptions(t),await Ee.getInstance().processTooltips(o)}}}(e,t)}};exports.AppStorys=Me,exports.Banner=K,exports.BottomSheet=ae,exports.CaptureScreenButton=he,exports.Csat=ie,exports.Floater=ge,exports.Measurable=Ae,exports.MeasurementProvider=$e,exports.Modal=ye,exports.Pip=Se,exports.PipScreen=xe,exports.Stories=Re,exports.StoriesScreen=je,exports.Survey=ee,exports.Widgets=re;
